@page "/SubirImagen"
@{
    ViewData["Title"] = "Cargar Imágenes por Lote";
    Layout = "_Layout";
}

<h1>Cargar Imagen</h1>

<form id="cargarImagenForm" class="needs-validation" enctype="multipart/form-data" novalidate>
    <div class="form-group">
        <label for="codigo">Código del Producto:</label>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="codigo" name="codigo" required>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="buscarProducto">Buscar</button>
            </div>
        </div>
        <div class="invalid-feedback">
            Por favor, ingrese un código de producto válido.
        </div>
    </div>
    <div id="productoInfo" style="display:none;">
        <div class="form-group">
            <label for="descripcion">Descripción:</label>
            <p id="descripcion" class="form-control-plaintext"></p>
        </div>
        <div class="form-group">
            <label>Imagen Actual:</label>
            <img id="imagenActual" src="" class="img-fluid img-thumbnail" alt="Imagen del producto">
        </div>
        <div class="form-group">
            <label for="nuevaImagen">Nueva Imagen:</label>
            <input type="file" class="form-control-file" id="nuevaImagen" name="nuevaImagen" required>
            <div class="invalid-feedback">
                Por favor, seleccione una imagen.
            </div>
        </div>
        <button class="btn btn-primary" type="button" id="subirImagen">Subir</button>
    </div>
</form>

@section Scripts {
    <script>
        document.getElementById('buscarProducto').addEventListener('click', function () {
            var codigo = document.getElementById('codigo').value;
            fetch(`/api/productos/${codigo}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('productoInfo').style.display = 'block';
                    document.getElementById('descripcion').innerText = data.descripcion;
                    document.getElementById('imagenActual').src = `/images/${data.imagenURL}`;
                });
        });

        document.getElementById('subirImagen').addEventListener('click', function () {
            var formData = new FormData();
            var codigo = document.getElementById('codigo').value;
            var nuevaImagen = document.getElementById('nuevaImagen').files[0];

            formData.append('codigo', codigo);
            formData.append('nuevaImagen', nuevaImagen);

            fetch('/api/Productos/SubirImagen', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    alert('Imagen subida con éxito');
                    document.getElementById('imagenActual').src = `/images/${data.imagenURL}`;
                })
                .catch(error => {
                    console.error('Error al subir la imagen:', error);
                });
        });
    </script>
}
